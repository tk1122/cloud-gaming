<html>
<head>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/adapterjs/0.15.5/adapter.min.js"></script>
</head>
<style>
    textarea {
        width: 60%;
        height: 50px;
    }

    audio {
        display: none;
    }
</style>
<div id="remoteVideos"></div>
<br/>
<div>
    Use Up, Down, Left, Right to move <br/>
    Z to A <br/>
    X to B <br/>
    C to select <br/>
    V to start <br/>
</div>

<button id="playGame" onclick="startStreaming()" disabled> Play Mario</button>
<script>
    const ws = new WebSocket("ws://localhost:8000/ws")
    const pc = new RTCPeerConnection({
        iceServers: [
            {
                urls: 'stun:stun.l.google.com:19302'
            }
        ],
    })
    const inputChannel = pc.createDataChannel('keystrokes', {
            priority: "high",
            ordered: false, // do not guarantee order
            maxPacketLifeTime: 3000, // in milliseconds
        }
    )
    pc.addTransceiver("audio", {direction: "recvonly"})
    pc.addTransceiver("video", {direction: "recvonly"})

    ws.onmessage = ev => {
        const msg = JSON.parse(ev.data)
        switch (msg.ID) {
            case "answer":
                pc.setRemoteDescription(new RTCSessionDescription({
                    sdp: msg.Data,
                    type: "answer"
                }))
                break;
            case "candidate":
                pc.addIceCandidate(JSON.parse(msg.Data))
                break;
        }
    }

    ws.onopen = () => {
        pc.createOffer({
            offerToReceiveVideo: true,
            offerToReceiveAudio: true
        }).then(d => pc.setLocalDescription(d)).then(() => {
            ws.send(JSON.stringify({
                ID: "offer",
                Data: pc.localDescription.sdp
            }))
        })

        pc.onicecandidate = ev => {
            if (ev.candidate) {
                ws.send(JSON.stringify({
                    ID: "candidate",
                    Data: ev.candidate.candidate
                }))
            }
        }
    }

    ws.onclose = () => {
        console.log("WEBSOCKET CLOSED!!!")
        pc.onicecandidate = () => {
        }
    }

    pc.ontrack = function (event) {
        const el = document.createElement(event.track.kind)
        el.srcObject = event.streams[0]
        el.autoplay = true
        el.controls = true

        document.getElementById('remoteVideos').appendChild(el)
    }


    const keysList = ["z", "x", "c", "v", "ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"]
    const keysState = new Array(keysList.length).fill(false)
    let unchangedPackets = 5;

    const setKeyState = (id, state) => {
        keysState[id] = state
        unchangedPackets = 5;
    }

    window.addEventListener("keydown", ev => {
        if (keysList.includes(ev.key)) {
            setKeyState(keysList.indexOf(ev.key), true)
        }
    })

    window.addEventListener("keyup", ev => {
        if (keysList.includes(ev.key)) {
            setKeyState(keysList.indexOf(ev.key), false)
        }
    })

    const sendInputInterval = inputChannel.onopen = () => {
        setInterval(() => {
            const keyString = keysState.reduce((acc, key) => {
                acc += key ? "1" : "0"
                return acc
            }, "")

            if (inputChannel.readyState === "open") {
                if (unchangedPackets > 0) {
                    inputChannel.send(keyString)
                    unchangedPackets--;
                }
            } else {
                clearInterval(sendInputInterval)
            }
        }, 10)
    }
    inputChannel.onclose = () => clearInterval(sendInputInterval)
</script>
</html>
