<html>
<head>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/adapterjs/0.15.5/adapter.min.js"></script>
</head>
<style>
    textarea {
        width: 60%;
        height: 50px;
    }

    audio {
        display: none;
    }
</style>
<div id="remoteVideos"></div>
<br/>
<div>
    Use Up, Down, Left, Right to move <br/>
    Z to A <br/>
    X to B <br/>
    C to select <br/>
    V to start <br/>
</div>

<button onclick="startSignaling(1, '')" class="signaling">Play as Player 1</button>
<br/>
<label for="roomId" id="roomLabel">Room id: </label><input type="text" id="roomId" class="signaling">
<button onclick="startSignaling2Player()" class="signaling">Play as Player 2</button>
<br/>
<div id="playerId"></div>
<button id="start" onclick="startStreaming()" disabled>Start game</button>
<script>
    let wsUrl
    const hostname = window.location.hostname
    if (document.location.protocol === "https:") {
        wsUrl = "wss://" + hostname + ":8000/ws"
    } else {
        wsUrl = "ws://" + hostname + ":8000/ws"
    }
    console.log(wsUrl)
    const pc = new RTCPeerConnection({
        iceServers: [
            {
                urls: 'stun:stun.l.google.com:19302'
            }
        ],
    })
    const inputChannel = pc.createDataChannel('keystrokes', {
            priority: "high",
            ordered: false, // do not guarantee order
            maxPacketLifeTime: 3000, // in milliseconds
        }
    )
    pc.addTransceiver("audio", {direction: "recvonly"})
    pc.addTransceiver("video", {direction: "recvonly"})
    let remoteDescription = ""
    let playerId

    function startStreaming() {
        pc.setRemoteDescription(new RTCSessionDescription({
            sdp: remoteDescription,
            type: "answer"
        }))
        document.querySelector("#start").style.display = "none"
        document.querySelector("#playerId").innerText = "You are " + (playerId === 1 ? "player 1" : "player 2")
    }

    function startSignaling2Player() {
        const roomId = document.querySelector("#roomId").value.trim()
        startSignaling(2, roomId)
    }

    function startSignaling(player, roomId) {
        playerId = player

        const ws = new WebSocket(wsUrl)

        ws.onmessage = ev => {
            const msg = JSON.parse(ev.data)
            switch (msg.id) {
                case "answer":
                    remoteDescription = msg.data
                    document.querySelector("#start").removeAttribute("disabled")
                    const elems = document.querySelectorAll(".signaling")
                    for (const e of elems) {
                        e.style.display = "none"
                    }
                    const roomIdSpanElem = document.createElement("span")
                    roomIdSpanElem.innerText = msg.room_id
                    document.querySelector("#roomLabel").appendChild(roomIdSpanElem)
                    break;
                case "candidate":
                    pc.addIceCandidate(JSON.parse(msg.data))
                    break;
            }
        }

        ws.onopen = () => {
            pc.createOffer({
                offerToReceiveVideo: true,
                offerToReceiveAudio: true
            }).then(d => pc.setLocalDescription(d)).then(() => {
                ws.send(JSON.stringify({
                    id: "offer",
                    data: pc.localDescription.sdp,
                    player_id: player,
                    room_id: roomId
                }))
            })

            pc.onicecandidate = ev => {
                if (ev.candidate) {
                    ws.send(JSON.stringify({
                        id: "candidate",
                        data: ev.candidate.candidate
                    }))
                }
            }
        }

        ws.onclose = () => {
            console.log("WEBSOCKET CLOSED!!!")
            pc.onicecandidate = () => {
            }
        }

        ws.onerror = ev => {
            console.log(ev)
        }

        pc.ontrack = function (event) {
            const el = document.createElement(event.track.kind)
            el.srcObject = event.streams[0]
            el.autoplay = true
            el.controls = true

            document.getElementById('remoteVideos').appendChild(el)
        }

        const keysList = ["z", "x", "c", "v", "ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"]
        const keysState = new Array(keysList.length).fill(false)
        let unchangedPackets = 5;

        const setKeyState = (id, state) => {
            keysState[id] = state
            unchangedPackets = 5;
        }

        window.addEventListener("keydown", ev => {
            if (keysList.includes(ev.key)) {
                setKeyState(keysList.indexOf(ev.key), true)
            }
        })

        window.addEventListener("keyup", ev => {
            if (keysList.includes(ev.key)) {
                setKeyState(keysList.indexOf(ev.key), false)
            }
        })

        const sendInputInterval = inputChannel.onopen = () => {
            setInterval(() => {
                const keyString = keysState.reduce((acc, key) => {
                    acc += key ? "1" : "0"
                    return acc
                }, "")

                if (inputChannel.readyState === "open") {
                    if (unchangedPackets > 0) {
                        inputChannel.send(keyString)
                        unchangedPackets--;
                    }
                } else {
                    clearInterval(sendInputInterval)
                }
            }, 10)
        }
        inputChannel.onclose = () => clearInterval(sendInputInterval)
    }

</script>
</html>
