<html>
<style>
    textarea {
        width: 60%;
        height: 50px;
    }

    audio {
        display: none;
    }
</style>
<div id="remoteVideos"></div>
<br/>
<div>
    Use Up, Down, Left, Right to move <br/>
    Z to A <br/>
    X to B <br/>
    C to select <br/>
    V to start <br/>
</div>

<button id="playGame" onclick="startStreaming()" disabled> Play Mario</button>
<script>
    const postSession = session => {
        const xhttp = new XMLHttpRequest();
        xhttp.onload = function () {
            if (this.status === 200) {
                remoteSessionDescription = this.responseText;
                document.getElementById('playGame').disabled = false;
            }
        };
        xhttp.open("POST", "/session", true);
        xhttp.setRequestHeader("Content-type", "text/plain");
        xhttp.send(session);

    }
    const startStreaming = () => {
        pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(atob(remoteSessionDescription))))
        console.log(JSON.parse(atob(remoteSessionDescription)).sdp)
    }

    const pc = new RTCPeerConnection({
        iceServers: [
            {
                urls: 'stun:stun.l.google.com:19302'
            }
        ]
    })
    const inputChannel = pc.createDataChannel('keystrokes')
    let remoteSessionDescription = ""

    pc.ontrack = function (event) {
        console.log(event)
        const el = document.createElement(event.track.kind)
        el.srcObject = event.streams[0]
        el.autoplay = true
        el.controls = true

        document.getElementById('remoteVideos').appendChild(el)
    }

    pc.oniceconnectionstatechange = e => console.log(pc.iceConnectionState)
    pc.onicecandidate = event => {
        if (event.candidate === null) {
            const session = btoa(JSON.stringify(pc.localDescription));
            console.log(pc.localDescription.sdp)
            postSession(session)
        }
    }

    pc.addTransceiver("audio", {direction: "recvonly"})
    pc.addTransceiver("video", {direction: "recvonly"})

    pc.createOffer({
        offerToReceiveVideo: true,
        offerToReceiveAudio: true
    }).then(d => pc.setLocalDescription(d))

    const dataChannelOptions = {
        ordered: false, // do not guarantee order
        maxPacketLifeTime: 3000, // in milliseconds
    };
    const keysList = ["z", "x", "c", "v", "ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"]
    const keysState = new Array(keysList.length).fill(false)
    let unchangedPackets = 5;

    const setKeyState = (id, state) => {
        keysState[id] = state
        unchangedPackets = 5;
    }

    window.addEventListener("keydown", ev => {
        if (keysList.includes(ev.key)) {
            setKeyState(keysList.indexOf(ev.key), true)
        }
    })

    window.addEventListener("keyup", ev => {
        if (keysList.includes(ev.key)) {
            setKeyState(keysList.indexOf(ev.key), false)
        }
    })

    const sendInputInterval = inputChannel.onopen = () => {
        setInterval(() => {
            const keyString = keysState.reduce((acc, key) => {
                acc += key ? "1" : "0"
                return acc
            }, "")

            if (inputChannel.readyState === "open") {
                if (unchangedPackets > 0) {
                    inputChannel.send(keyString)
                    unchangedPackets--;
                }
            } else {
                clearInterval(sendInputInterval)
            }
        }, 100)
    }
    inputChannel.onclose = () => clearInterval(sendInputInterval)
</script>
</html>
